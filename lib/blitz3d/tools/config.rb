require 'pathname'

module Blitz3D
  module Tools
    module Config
      PREMAKE_DIR = 'build/src'
      TOOLCHAINS_DIR = File.join(File.dirname(Blitz3D.path), '..', '_release', 'toolchains')

      def file_has_changed?(file, string)
        File.open(file).read != string
      rescue Errno::ENOENT
        true
      end

      def link_stub(mod)
        puts "Generating stub for #{mod.name.bold}..."
        f = StringIO.new
        f.write "// AUTOGENERATED. DO NOT EDIT.\n"
        f.write "// RUN `bin/blitz3d config` TO UPDATE.\n\n"
        f.write "#include <bb/blitz/module.h>\n"
        f.write "#include <bb/#{mod.id}/#{mod.id}.h>\n\n"
        f.write "#ifdef WIN32\n"
        f.write "BBMODULE_LINK( #{mod.id.parameterize.underscore} ){\n"
        mod.symbols.each_pair do |ident, sym|
          f.write "\trtSym( \"#{ident}\",#{sym} );\n"
        end

        mod.commands.each do |command|
          params = command.params.map(&:to_rtsym)
          sym = "#{command.return_type}#{command.name}#{params.join('')}".inspect
          f.write "\trtSym( #{sym},#{command.symbol} );\n"
        end
        f.write "}\n"
        f.write "#endif\n"

        out_file = File.join('src', 'modules', 'bb', mod.id, 'module.link.cpp')

        if file_has_changed?(out_file, f.string)
          File.open(out_file, 'w') { |h| h.write f.string }
        end
      end

      def modules
        Module.all.each do |mod|
          if mod.needs_to_link?
            link_stub mod
          else
            FileUtils.rm "src/modules/bb/#{mod.id}/module.link.cpp" rescue Errno::ENOENT
          end
        end

        mods = Module.all.group_by(&:platforms)

        File.open('src/modules/CMakeLists.txt', 'w') do |f|
          f.write "# AUTOGENERATED. DO NOT EDIT.\n"
          f.write "# RUN `bin/blitz3d config` TO UPDATE.\n\n"
          f.write("set (CMAKE_CXX_STANDARD 11)\n\n")
          f.write("include_directories (SYSTEM .)\n\n")

          mods.each_pair do |platforms, valid_mods|
            stmts = valid_mods.map { |mod| "add_subdirectory(bb/#{mod.id})" }
            if platforms != Module::PLATFORMS
              conds = platforms.map { |p| "BB_#{p.upcase}" }
              f.write("IF(#{conds.join(' OR ')})\n")
              stmts.each do |stmt|
                f.write("  #{stmt}\n")
              end
              f.write("ENDIF()\n\n")
            else
              f.write stmts.join("\n")
              f.write "\n\n"
            end
          end
        end
      end

      def runtimes
        Runtime.all.each do |runtime|
          puts "Generating runtime #{runtime.name.bold}..."
          runtime.platforms.each do |platform|
            puts "  #{platform}..."
            modules = runtime.dependencies(:list, platform)

            config = {}
            config[:modules] = modules.map do |mod|
              {
                id: mod.id,
                links: mod.libraries(platform)
              }
            end

            config[:commands] = modules.map do |mod|
              mod.commands.map do |command|
                {
                  name: command.name,
                  return_type: command.return_type,
                  symbol: command.symbol,
                  parameters: command.params.map do |param|
                    { ident: param.identifier, type: param.type, default: param.default }
                  end
                }
              end
            end.flatten

            FileUtils.mkdir_p File.join(TOOLCHAINS_DIR, platform)

            File.open(File.join(TOOLCHAINS_DIR, platform, "#{runtime.id}.runtime.json"), 'w') { |t| t.write JSON.pretty_generate(config) }

            f = StringIO.new
            f.write "// AUTOGENERATED. DO NOT EDIT.\n"
            f.write "// RUN `bin/blitz3d config` TO UPDATE.\n"
            f.write("\n#include <bb/stub/stub.h>\n\n")
            f.write("\n#include \"../../stdutil/stdutil.h\"\n\n")

            modules.each do |mod|
              f.write("BBMODULE_DECL( #{mod.id.parameterize.underscore} );\n")
            end

            f.write("\nclass BBRuntime;\n")
            f.write("BBRuntime *#{runtime.entry['runtime']}();\n")
            f.write("BBRuntime *bbCreateRuntime(){\n")
            f.write("\treturn #{runtime.entry['runtime']}();\n")
            f.write("}\n\n")

            f.write("#ifdef WIN32")
            f.write("\nvoid bbruntime_link( void (*link)( const char *sym,void *pc ) ){\n")
              modules.select(&:needs_to_link?).each do |mod|
                f.write("\t#{mod.id.parameterize.underscore}_link( link );\n")
              end
            f.write("}\n")
            f.write("#endif")

            f.write("\nbool bbruntime_create(){\n")
            write_create_calls = lambda do |i, l|
              (i + 1).times { f.write "\t" }
              id = modules[i].id.parameterize.underscore
              f.write("if( #{id}_create() ){\n")
              (i + 2).times { f.write "\t" }
              if i < modules.size - 1
                l.call(i + 1, l)
                (i + 1).times { f.write "\t" }
                f.write("\t#{id}_destroy();\n");
              else
                (i + 1).times { f.write "\t" }
                f.write("\treturn true;\n")
              end
              (i + 1).times { f.write "\t" }
              f.write("}else sue( \"#{id}_create failed\" );\n")
            end
            write_create_calls.call 0, write_create_calls
            f.write("\treturn false;\n")
            f.write("}\n")

            f.write("\nbool bbruntime_destroy(){\n")
            modules.reverse.each do |mod|
              f.write("\t#{mod.id.parameterize.underscore}_destroy();\n")
            end
            f.write("\treturn true;\n")
            f.write("}\n")

            runtime_stub_file = "src/runtime/#{runtime.id}/#{platform}.cpp"

            if file_has_changed?(runtime_stub_file, f.string)
              File.open(runtime_stub_file, 'w') { |t| t.write f.string }
            end
          end

          f = StringIO.new
          f.write "# AUTOGENERATED. DO NOT EDIT.\n"
          f.write "# RUN `bin/blitz3d config` TO UPDATE.\n\n"
          f.write "include_directories (SYSTEM ../../modules)\n\n"
          f.write "IF (BB_WINDOWS)\n"
          f.write "set (SYSTEM_LIBS libcmt)\n"
          f.write "ENDIF()\n\n"

          runtime.platforms.each.with_index do |platform, i|
            deps = runtime.dependencies(:list, platform).map { |dep| "bb.#{dep.id}" }

            f.write("#{'ELSE' if i > 0}IF(BB_#{platform.upcase})\n")
            f.write("  add_library(runtime.#{runtime.id} STATIC #{platform}.cpp)\n")
            f.write("  target_link_libraries(runtime.#{runtime.id} #{deps.join(' ')} ${SYSTEM_LIBS})\n") unless deps.empty?

            f.write("\n  add_library(runtime.#{runtime.id}.bin SHARED)\n")
            f.write("  target_link_libraries(runtime.#{runtime.id}.bin runtime.#{runtime.id})\n") unless deps.empty?
            f.write("ENDIF()\n") if i == runtime.platforms.size - 1
          end

          out_file = "src/runtime/#{runtime.id}/CMakeLists.txt"
          if file_has_changed?(out_file, f.string)
            File.open(out_file, 'w') { |t| t.write f.string }
          end
        end

        File.open('src/runtime/CMakeLists.txt', 'w') do |f|
          f.write "# AUTOGENERATED. DO NOT EDIT.\n"
          f.write "# RUN `bin/blitz3d config` TO UPDATE.\n\n"
          f.write("set (CMAKE_CXX_STANDARD 11)\n\n")
          Runtime.all.each do |runtime|
            f.write("add_subdirectory(#{runtime.id})\n")
          end
        end
      end

      def run
        modules
        runtimes
      end
    end
  end
end
